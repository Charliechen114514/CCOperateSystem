# 实现lseek

```c
/* Reset the offset pointer used for file read/write operations, return the new
 * offset on success, return -1 if an error occurs
 */
int32_t sys_lseek(int32_t fd, int32_t offset, uint8_t whence) {
    if (fd < 0) {
        ccos_printk("sys_lseek: fd error\n");
        return -1;
    }
    KERNEL_ASSERT(whence > 0 && whence < 4);
    uint32_t _fd = fd_local2global(fd);
    File *pf = &file_table[_fd];
    int32_t new_pos = 0; // The new position must be within the file size
    int32_t file_size = (int32_t)pf->fd_inode->i_size;
    switch (whence) {
    /* SEEK_SET - The new read/write position is offset from the beginning of
     * the file */
    case SEEK_SET:
        new_pos = offset;
        break;

    /* SEEK_CUR - The new read/write position is offset from the current
     * position */
    case SEEK_CUR: // offset can be positive or negative
        new_pos = (int32_t)pf->fd_pos + offset;
        break;

    /* SEEK_END - The new read/write position is offset from the end of the file
     */
    case SEEK_END: // In this case, offset should be negative
        new_pos = file_size + offset;
    }
    if (new_pos < 0 || new_pos > (file_size - 1)) {
        return -1;
    }
    pf->fd_pos = new_pos;
    return pf->fd_pos;
}
```

`sys_lseek` 函数用于重置文件的偏移量指针。根据给定的文件描述符 `fd`、偏移量 `offset` 和位置类型 `whence`，计算新的偏移量并更新文件指针。首先检查文件描述符是否有效。然后验证 `whence` 参数是否合法（在 1 到 3 之间）。通过 `fd_local2global` 转换为全局文件描述符，获取文件对象 `pf`。接下来，根据 `whence` 的值进行处理。`SEEK_SET` 设置新的偏移量为 `offset`；`SEEK_CUR` 将当前偏移量加上 `offset`；`SEEK_END` 将偏移量设置为文件末尾加上 `offset`。如果计算出的新的偏移量无效（小于 0 或大于文件大小），则返回 `-1`。否则，更新文件的偏移量指针并返回新的偏移量。

## 测试

```c
#include "include/device/console_tty.h"
#include "include/kernel/init.h"
#include "include/library/kernel_assert.h"
#include "include/thread/thread.h"
#include "include/user/stdio/stdio.h"
#include "include/memory/memory.h"
#include "include/library/ccos_print.h"
#include "include/filesystem/filesystem.h"
#include "include/library/string.h"
int main(void) { 
    init_all();
    uint32_t fd = sys_open("/file1", O_RDWR); 
    printf("open /file1, fd:%d\n", fd); 
    char buf[64] = {0}; 
    int read_bytes = sys_read(fd, buf, 18); 
    printf("1_ read %d bytes:\n%s\n", read_bytes, buf); 

    k_memset(buf, 0, 64); 
    read_bytes = sys_read(fd, buf, 6); 
    printf("2_ read %d bytes:\n%s", read_bytes, buf); 

    k_memset(buf, 0, 64); 
    read_bytes = sys_read(fd, buf, 6); 
    printf("3_ read %d bytes:\n%s", read_bytes, buf); 

    printf("________  SEEK_SET 0  ________\n"); 
    sys_lseek(fd, 0, SEEK_SET); 
    k_memset(buf, 0, 64); 
    read_bytes = sys_read(fd, buf, 24); 
    printf("4_ read %d bytes:\n%s", read_bytes, buf); 

    sys_close(fd); 
    while(1); 
    return 0; 
}
```

![image-20250309231705074](./13.6_lseek/image-20250309231705074.png)