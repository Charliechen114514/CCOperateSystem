# 实现stat

​	stat用来得到文件的类型、权限、属主、时间。我们来做一下：

```
typedef struct
{
   uint32_t st_ino;             // Inode number
   uint32_t st_size;            // File size
   enum file_types st_filetype; // File type
}Stat;
```

​	下面来实现这个系统调用

```c
/* Fills the buf with the file structure information. Returns 0 on success, -1
 * on failure */
int32_t sys_stat(const char *path, Stat *buf) {
    /* If directly querying the root directory '/' */
    if (!k_strcmp(path, "/") || !k_strcmp(path, "/.") || !k_strcmp(path, "/..")) {
        buf->st_filetype = FT_DIRECTORY;
        buf->st_ino = 0;
        buf->st_size = root_dir.inode->i_size;
        return 0;
    }

    int32_t ret = -1; // Default return value
    PathSearchRecordings searched_record;
    k_memset(
        &searched_record, 0,
        sizeof(PathSearchRecordings)); // Initialize or clear, otherwise
                                            // the stack information is unknown
    int inode_no = search_file(path, &searched_record);
    if (inode_no != -1) {
        Inode *obj_inode =
            inode_open(cur_part, inode_no); // Open only to get the file size
        buf->st_size = obj_inode->i_size;
        inode_close(obj_inode);
        buf->st_filetype = searched_record.file_type;
        buf->st_ino = inode_no;
        ret = 0;
    } else {
        ccos_printk("sys_stat: %s not found\n", path);
    }
    dir_close(searched_record.parent_dir);
    return ret;
}
```

​	`sys_stat` 系统调用，用于获取指定路径（`path`）的文件信息，并将其存储在 `Stat` 结构体 `buf` 中。首先检查传入的路径是否是根目录 (`/`)、当前目录 (`/.`) 或上级目录 (`/..`)。如果是根目录，则直接将文件类型设为目录 (`FT_DIRECTORY`)，inode 号设为 `0`（根目录的 inode 号），并将根目录的大小（`root_dir.inode->i_size`）写入 `buf->st_size`。如果路径不是根目录或特殊目录，则通过 `search_file` 函数查找路径。如果路径存在，返回路径对应的 inode 号，并将相关的文件信息存入 `Stat` 结构体，包括文件的大小 `obj_inode->i_size` 和文件类型 `searched_record.file_type`，以及 inode 号 `inode_no`。查找完成后，关闭 inode。如果路径不存在，则输出错误信息并返回 `-1`。最后，关闭查找过程中的父目录。

## 上电测试

```c
int main(void)
{
    init_all();
    Stat obj_stat;
    sys_stat("/", &obj_stat);
    printf("/`s info\n   i_no:%d\n   size:%d\n   filetype:%s\n",
           obj_stat.st_ino, obj_stat.st_size,
           obj_stat.st_filetype == 2 ? "directory" : "regular");
    sys_stat("/dir1", &obj_stat);
    printf("/dir1`s info\n   i_no:%d\n   size:%d\n   filetype:%s\n",
           obj_stat.st_ino, obj_stat.st_size,
           obj_stat.st_filetype == 2 ? "directory" : "regular");

    while (1)
        ;
    return 0;
}
```

![image-20250309234331926](./13.10_stat/image-20250309234331926.png)
